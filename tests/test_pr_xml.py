import os.path
from urllib import parse
import uuid

import cv2
from tqdm import tqdm

from src.heigher_service.utils.common import BLUtils
from src.heigher_service.utils.pr_sequence_utils import PrSequenceUtils, ClipItem, PrFile


def get_ab_point_2():
    return [(1737, 1, 26), (1764, 27, 11), (2108, 38, 62), (2140, 100, 48), (2190, 148, 11), (2306, 159, 12),
            (2318, 171, 19), (2448, 190, 46), (2518, 236, 23), (2546, 259, 26), (2584, 285, 31), (2619, 316, 11),
            (3137, 327, 12), (3150, 339, 73), (3226, 412, 53), (3450, 465, 56), (3394, 521, 23), (3433, 544, 11),
            (3518, 555, 12), (3530, 567, 11), (3542, 578, 11), (3553, 589, 11), (3564, 600, 23), (3677, 623, 37),
            (3716, 660, 40), (3758, 700, 11), (3769, 711, 121), (3900, 832, 12), (3908, 844, 11), (3919, 855, 51),
            (3974, 906, 18), (4036, 924, 28), (4296, 952, 35), (4373, 987, 38), (4506, 1025, 43), (4556, 1068, 11),
            (4562, 1079, 29), (4593, 1108, 72), (4668, 1180, 59), (4731, 1239, 39), (4772, 1278, 11), (4822, 1289, 30),
            (4869, 1319, 34), (4989, 1353, 47), (5036, 1400, 23), (5062, 1423, 13), (5075, 1436, 22), (5113, 1458, 34),
            (5149, 1492, 11), (5191, 1503, 35), (5513, 1538, 50), (5248, 1588, 27), (5574, 1615, 33), (5711, 1648, 11),
            (5723, 1659, 11), (5740, 1670, 23), (5764, 1693, 45), (5811, 1738, 83), (5897, 1821, 51), (5951, 1872, 28),
            (5981, 1900, 47), (6058, 1947, 38), (6120, 1985, 18), (6139, 2003, 50), (6191, 2053, 17), (6216, 2070, 88),
            (6307, 2158, 79), (6401, 2237, 39), (6334, 2276, 53), (6413, 2329, 43), (6581, 2372, 45), (6628, 2417, 11),
            (6690, 2428, 41), (6920, 2469, 21), (6996, 2490, 19), (7353, 2509, 20), (7521, 2529, 11), (7532, 2540, 26),
            (7720, 2566, 61), (7806, 2627, 18), (7829, 2645, 28), (7864, 2673, 55), (7922, 2728, 19), (7952, 2747, 43),
            (7997, 2790, 17), (8014, 2807, 47), (8063, 2854, 28), (8036, 2882, 27), (8065, 2909, 12), (8077, 2921, 11),
            (8173, 2932, 12), (8185, 2944, 11), (8247, 2955, 14), (8261, 2969, 64), (8296, 3033, 27), (8799, 3060, 29),
            (8965, 3089, 31), (9015, 3120, 26), (9306, 3146, 37), (9459, 3183, 25), (9458, 3208, 12), (9498, 3220, 11),
            (9509, 3231, 46), (9627, 3277, 13), (9640, 3290, 31), (9693, 3321, 26), (9561, 3347, 37), (9715, 3384, 61),
            (9877, 3445, 34), (10199, 3479, 74), (10313, 3553, 79), (10396, 3632, 55), (10664, 3687, 11),
            (10675, 3698, 33), (10709, 3731, 13), (10723, 3744, 24), (10776, 3768, 21), (10798, 3789, 11),
            (10870, 3800, 42), (11058, 3842, 14), (11072, 3856, 11), (11084, 3867, 27), (11328, 3894, 14),
            (11345, 3908, 13), (11458, 3921, 13), (11471, 3934, 25), (11564, 3959, 14), (11583, 3976, 20),
            (11801, 3996, 34), (11894, 4030, 31), (11972, 4061, 54), (12026, 4115, 26), (12055, 4141, 15),
            (12071, 4156, 21), (12092, 4177, 32), (12126, 4209, 57), (12200, 4266, 22), (12258, 4288, 11),
            (12270, 4299, 11), (12548, 4310, 35), (12742, 4345, 28), (12808, 4373, 39), (13033, 4412, 33),
            (13068, 4445, 15), (13193, 4460, 33), (13424, 4493, 11), (13435, 4504, 11), (13447, 4515, 20),
            (13467, 4535, 20), (13789, 4555, 21), (13811, 4576, 13), (13949, 4589, 95), (14051, 4684, 15),
            (14066, 4699, 50), (14118, 4749, 32), (14152, 4781, 15), (14186, 4796, 33), (14278, 4829, 19),
            (14297, 4848, 30), (14329, 4878, 18), (14363, 4896, 12), (14376, 4908, 21), (14752, 4929, 15),
            (14767, 4944, 25), (14820, 4969, 65), (14887, 5034, 59), (14949, 5093, 82), (15035, 5175, 12),
            (15046, 5187, 15), (15068, 5202, 14), (15300, 5216, 34), (15518, 5250, 38), (15558, 5288, 72),
            (15633, 5360, 11), (15644, 5371, 39)]


def get_ab_point():
    return [(1737, 1, 26), (1763, 27, 11), (2114, 38, 45), (2120, 83, 46), (2170, 129, 17), (2170, 146, 11),
            (2303, 157, 11), (2314, 168, 11), (2326, 179, 11), (2447, 190, 12), (2460, 202, 11), (2471, 213, 12),
            (2484, 225, 11), (2518, 236, 11), (2533, 247, 11), (2541, 258, 11), (2556, 269, 12), (2568, 281, 11),
            (2593, 292, 20), (2613, 312, 11), (3133, 323, 16), (3149, 339, 11), (3160, 350, 30), (3191, 380, 15),
            (3207, 395, 12), (3210, 407, 11), (3231, 418, 57), (3448, 475, 11), (3470, 486, 22), (3494, 508, 12),
            (3495, 520, 11), (3419, 531, 11), (3430, 542, 11), (3514, 553, 14), (3529, 567, 11), (3540, 578, 11),
            (3552, 589, 11), (3563, 600, 11), (3575, 611, 11), (3675, 622, 11), (3687, 633, 12), (3700, 645, 14),
            (3714, 659, 16), (3731, 675, 13), (3744, 688, 11), (3756, 699, 11), (3767, 710, 12), (3780, 722, 27),
            (3808, 749, 82), (3893, 831, 11), (3904, 842, 11), (3916, 853, 16), (3933, 869, 11), (3944, 880, 11),
            (3956, 891, 11), (3967, 902, 11), (3980, 913, 11), (4035, 924, 17), (4053, 941, 11), (4295, 952, 28),
            (4313, 980, 17), (4403, 997, 11), (4393, 1008, 16), (4504, 1024, 11), (4516, 1035, 11), (4527, 1046, 15),
            (4543, 1061, 15), (4558, 1076, 13), (4572, 1089, 11), (4583, 1100, 35), (4620, 1135, 11), (4631, 1146, 11),
            (4650, 1157, 16), (4656, 1173, 11), (4662, 1184, 18), (4674, 1202, 11), (4702, 1213, 12), (4715, 1225, 13),
            (4732, 1241, 11), (4743, 1252, 11), (4757, 1265, 11), (4769, 1276, 11), (4820, 1287, 30), (4866, 1317, 35),
            (4987, 1352, 19), (5007, 1371, 12), (5008, 1383, 27), (5040, 1410, 21), (5050, 1431, 11), (5080, 1442, 15),
            (5111, 1457, 18), (5130, 1475, 11), (5141, 1486, 11), (5153, 1497, 11), (5195, 1508, 11), (5207, 1519, 18),
            (5509, 1537, 50), (5246, 1587, 27), (5584, 1614, 33), (5710, 1647, 12), (5710, 1659, 11), (5736, 1670, 21),
            (5761, 1691, 16), (5778, 1707, 11), (5789, 1718, 19), (5810, 1737, 35), (5846, 1772, 12), (5846, 1784, 20),
            (5847, 1804, 12), (5890, 1816, 12), (5892, 1828, 19), (5900, 1847, 11), (5926, 1858, 24), (5940, 1882, 11),
            (5972, 1893, 11), (5984, 1904, 31), (6016, 1935, 11), (6055, 1946, 16), (6072, 1962, 19), (6092, 1981, 11),
            (6126, 1992, 11), (6138, 2003, 16), (6155, 2019, 13), (6168, 2032, 15), (6184, 2047, 12), (6185, 2059, 11),
            (6220, 2070, 14), (6224, 2084, 11), (6241, 2095, 20), (6263, 2115, 33), (6280, 2148, 11), (6307, 2159, 32),
            (6340, 2191, 51), (6385, 2242, 39), (6433, 2281, 11), (6350, 2292, 36), (6411, 2328, 21), (6433, 2349, 11),
            (6445, 2360, 11), (6579, 2371, 16), (6596, 2387, 12), (6597, 2399, 11), (6620, 2410, 16), (6686, 2426, 12),
            (6690, 2438, 11), (6710, 2449, 11), (6721, 2460, 11), (6920, 2471, 18), (6994, 2489, 19), (7351, 2508, 20),
            (7519, 2528, 11), (7530, 2539, 26), (7706, 2565, 36), (7706, 2601, 11), (7757, 2612, 21), (7761, 2633, 17),
            (7820, 2650, 41), (7861, 2691, 47), (7920, 2738, 11), (7953, 2749, 26), (7980, 2775, 11), (7991, 2786, 20),
            (8012, 2806, 47), (8061, 2853, 14), (8076, 2867, 14), (8040, 2881, 12), (8035, 2893, 27), (8052, 2920, 11),
            (8090, 2931, 11), (8182, 2942, 11), (8243, 2953, 16), (8260, 2969, 11), (8272, 2980, 53), (8294, 3033, 26),
            (8797, 3059, 29), (8963, 3088, 12), (8964, 3100, 17), (8994, 3117, 11), (9023, 3128, 17), (9319, 3145, 37),
            (9458, 3182, 11), (9458, 3193, 11), (9467, 3204, 17), (9481, 3221, 11), (9510, 3232, 37), (9550, 3269, 11),
            (9628, 3280, 11), (9640, 3291, 12), (9653, 3303, 12), (9654, 3315, 11), (9852, 3326, 13), (9830, 3339, 14),
            (9560, 3353, 30), (9852, 3383, 13), (9854, 3396, 11), (9745, 3407, 11), (9850, 3418, 15), (9730, 3433, 27),
            (9854, 3460, 11), (9750, 3471, 11), (10011, 3482, 11), (10210, 3493, 11), (10224, 3504, 14),
            (10240, 3518, 27), (10304, 3545, 13), (10318, 3558, 34), (10320, 3592, 17), (10354, 3609, 40),
            (10335, 3649, 11), (10424, 3660, 26), (10663, 3686, 12), (10660, 3698, 11), (10686, 3709, 11),
            (10697, 3720, 11), (10710, 3731, 13), (10710, 3744, 11), (10740, 3761, 11), (10780, 3772, 12),
            (10792, 3784, 15), (10868, 3799, 16), (10880, 3815, 11), (10896, 3826, 15), (11055, 3841, 15),
            (11071, 3856, 11), (11082, 3867, 12), (11095, 3879, 14), (11330, 3893, 14), (11330, 3907, 13),
            (11456, 3920, 11), (11467, 3931, 14), (11482, 3945, 13), (11562, 3958, 11), (11574, 3969, 14),
            (11588, 3983, 12), (11800, 3995, 34), (11891, 4029, 15), (11900, 4044, 12), (11909, 4056, 11),
            (11977, 4067, 35), (12013, 4102, 12), (12026, 4114, 25), (12052, 4139, 12), (12053, 4151, 11),
            (12076, 4162, 12), (12090, 4174, 12), (12089, 4186, 14), (12104, 4200, 11), (12127, 4211, 19),
            (12147, 4230, 14), (12161, 4244, 12), (12162, 4256, 11), (12200, 4267, 12), (12201, 4279, 11),
            (12259, 4290, 11), (12271, 4301, 11), (12550, 4312, 12), (12549, 4324, 11), (12573, 4335, 11),
            (12742, 4346, 17), (12760, 4363, 11), (12810, 4374, 37), (13031, 4411, 22), (13054, 4433, 11),
            (13066, 4444, 15), (13191, 4459, 13), (13205, 4472, 15), (13220, 4487, 11), (13428, 4498, 12),
            (13440, 4510, 11), (13452, 4521, 14), (13466, 4535, 13), (13480, 4548, 11), (13792, 4559, 13),
            (13807, 4572, 12), (13820, 4584, 11), (13954, 4595, 44), (13990, 4639, 58), (14050, 4697, 11),
            (14076, 4708, 40), (14116, 4748, 24), (14141, 4772, 23), (14184, 4795, 12), (14197, 4807, 11),
            (14208, 4818, 11), (14276, 4829, 19), (14297, 4848, 28), (14326, 4876, 11), (14337, 4887, 11),
            (14364, 4898, 11), (14376, 4909, 15), (14464, 4924, 11), (14757, 4935, 14), (14772, 4949, 12),
            (14782, 4961, 11), (14822, 4972, 12), (14823, 4984, 36), (14871, 5020, 11), (14883, 5031, 40),
            (14925, 5071, 12), (14926, 5083, 11), (14949, 5094, 12), (14961, 5106, 16), (14978, 5122, 12),
            (14980, 5134, 11), (15002, 5145, 26), (15030, 5171, 13), (15031, 5184, 11), (15054, 5195, 11),
            (15071, 5206, 11), (15300, 5217, 32), (15516, 5249, 35), (15541, 5284, 11), (15558, 5295, 11),
            (15575, 5306, 14), (15590, 5320, 18), (15610, 5338, 21), (15631, 5359, 11), (15642, 5370, 11),
            (15654, 5381, 11), (15665, 5392, 17)]


def get_file_by_path(f_list, temp_path):
    for f in f_list:
        if f.file_path == temp_path:
            return f

    file = PrFile().generate_file(temp_path)
    print(f'create file [{temp_path}] len f_list = [{len(f_list)}]')

    f_list.append(file)

    return file


def generate_clip_item(a_start, b_start, temp_length, temp_path, temp_file_list):
    temp_ffile = get_file_by_path(temp_file_list, temp_path)
    clip_item = ClipItem().generate_clip_item_full((b_start, b_start + temp_length), (a_start, a_start + temp_length),
                                                   fps=temp_ffile.fps, total_frames=temp_ffile.total_frames,
                                                   name=BLUtils.get_filename(temp_ffile.file_path))
    clip_item.file = temp_ffile

    return clip_item


class RunnerClass:

    @staticmethod
    def generate_result_xml_path(video_name):
        result_dir = '../static/result/'
        file_name, ext = os.path.splitext(video_name)
        xml_name = file_name + '.xml'
        result_file = os.path.join(result_dir, xml_name)
        result_path = BLUtils.get_unique_filename(result_file)
        return result_path

    @staticmethod
    def get_all_info_str(a_path):
        video_name = BLUtils.get_filename(a_path)

        # 使用 OpenCV 获取视频相关信息
        cap = cv2.VideoCapture(a_path)
        if not cap.isOpened():
            print("Error opening video file")
            return

        fps = cap.get(cv2.CAP_PROP_FPS)

        if fps % 1 < 0.01:
            fps = int(fps)

        total_frames = int(cap.get(cv2.CAP_PROP_FRAME_COUNT))
        width = int(cap.get(cv2.CAP_PROP_FRAME_WIDTH))

        height = int(cap.get(cv2.CAP_PROP_FRAME_HEIGHT))

        # 注意：这里假设 file_path 是一个绝对路径
        file_url = parse.quote(a_path)
        path_url = f"file://localhost/{file_url}"
        cap.release()

        return str(total_frames), str(fps), str(video_name), str(width), str(height), str(path_url)

    @staticmethod
    def generate_base_xml():

        file_template_path = '../static/xml_template/base_template.xml'

        with open(file_template_path, 'r') as f:
            data = f.read()

        return data

    @staticmethod
    def generate_file_label():

        file_template_path = '../static/xml_template/file_template.xml'

        with open(file_template_path, 'r') as f:
            data = f.read()

        return data

    @staticmethod
    def generate_clip_items(ab_points, audio_index=None):
        clip_item_path = '../static/xml_template/clip_item_template.xml'

        with open(clip_item_path, 'r') as f:
            data = f.read()
            # print(data)

        clip_items = []

        for a_s, b_s, length in ab_points:
            clip_id = uuid.uuid4().__str__()
            start, end = b_s, b_s + length
            in_, out = a_s, a_s + length

            temp_data = data
            temp_data = temp_data.replace('{clip_item_id}', clip_id)
            temp_data = temp_data.replace('{start}', str(start))
            temp_data = temp_data.replace('{end}', str(end))
            temp_data = temp_data.replace('{in}', str(in_))
            temp_data = temp_data.replace('{out}', str(out))

            if audio_index is None:
                temp_data = temp_data.replace('{source_track}', '')
            elif audio_index == 1:
                temp_data = temp_data.replace('{source_track}', """<sourcetrack>
    <mediatype>audio</mediatype>
    <trackindex>1</trackindex>
</sourcetrack>""")
            elif audio_index == 2:
                temp_data = temp_data.replace('{source_track}', """<sourcetrack>
   <mediatype>audio</mediatype>
   <trackindex>2</trackindex>
</sourcetrack>""")
            else:
                raise Exception('未知的参数')

            clip_items.append(temp_data)

        # 如果是视频clip_items 需要把第一个file标签替换掉
        first_item = clip_items[0]
        first_item = first_item.replace('<file id="file-5"/>', RunnerClass.generate_file_label())

        clip_items[0] = first_item

        return str.join('\n', clip_items)


def main():
    ab_points = get_ab_point_2()

    a_path = "E:/data/02e06 Source.mp4"
    b_path = "E:/360MoveData/Users/MrB/Desktop/企鹅特工孵化鸭子，用训练作为胎教，结果鸭子一出生就成为特工@不正经的小酥肉.mp4"

    video_clip_items = RunnerClass.generate_clip_items(ab_points, None)
    audio_clip_items_1 = RunnerClass.generate_clip_items(ab_points, 1)
    audio_clip_items_2 = RunnerClass.generate_clip_items(ab_points, 2)

    base_xml = RunnerClass.generate_base_xml()
    base_xml = base_xml.replace('{video_clip_items}', video_clip_items)
    base_xml = base_xml.replace('{audio_clip_items_1}', audio_clip_items_1)
    base_xml = base_xml.replace('{audio_clip_items_2}', audio_clip_items_2)

    # 替换掉所有得主要信息 total_frames fps video_name width height path_url

    total_frames, fps, video_name, width, height, path_url = RunnerClass.get_all_info_str(a_path)

    base_xml = base_xml.replace('{total_frames}', total_frames)
    base_xml = base_xml.replace('{fps}', fps)
    base_xml = base_xml.replace('{video_name}', video_name)
    base_xml = base_xml.replace('{width}', width)
    base_xml = base_xml.replace('{height}', height)
    base_xml = base_xml.replace('{path_url}', path_url)

    # print(base_xml)
    result_path = RunnerClass.generate_result_xml_path(video_name)

    with open(result_path, 'w') as result_video_file:
        result_video_file.write(base_xml)

    print(f'已生成xml文件 >> {result_path}')


if __name__ == '__main__':
    main()
