import uuid

from tqdm import tqdm

from src.heigher_service.utils.common import BLUtils
from src.heigher_service.utils.pr_sequence_utils import PrSequenceUtils, ClipItem, PrFile


def get_ab_point():
    return [(1737, 1, 26), (1763, 27, 11), (2114, 38, 45), (2120, 83, 46), (2170, 129, 17), (2170, 146, 11),
            (2303, 157, 11), (2314, 168, 11), (2326, 179, 11), (2447, 190, 12), (2460, 202, 11), (2471, 213, 12),
            (2484, 225, 11), (2518, 236, 11), (2533, 247, 11), (2541, 258, 11), (2556, 269, 12), (2568, 281, 11),
            (2593, 292, 20), (2613, 312, 11), (3133, 323, 16), (3149, 339, 11), (3160, 350, 30), (3191, 380, 15),
            (3207, 395, 12), (3210, 407, 11), (3231, 418, 57), (3448, 475, 11), (3470, 486, 22), (3494, 508, 12),
            (3495, 520, 11), (3419, 531, 11), (3430, 542, 11), (3514, 553, 14), (3529, 567, 11), (3540, 578, 11),
            (3552, 589, 11), (3563, 600, 11), (3575, 611, 11), (3675, 622, 11), (3687, 633, 12), (3700, 645, 14),
            (3714, 659, 16), (3731, 675, 13), (3744, 688, 11), (3756, 699, 11), (3767, 710, 12), (3780, 722, 27),
            (3808, 749, 82), (3893, 831, 11), (3904, 842, 11), (3916, 853, 16), (3933, 869, 11), (3944, 880, 11),
            (3956, 891, 11), (3967, 902, 11), (3980, 913, 11), (4035, 924, 17), (4053, 941, 11), (4295, 952, 28),
            (4313, 980, 17), (4403, 997, 11), (4393, 1008, 16), (4504, 1024, 11), (4516, 1035, 11), (4527, 1046, 15),
            (4543, 1061, 15), (4558, 1076, 13), (4572, 1089, 11), (4583, 1100, 35), (4620, 1135, 11), (4631, 1146, 11),
            (4650, 1157, 16), (4656, 1173, 11), (4662, 1184, 18), (4674, 1202, 11), (4702, 1213, 12), (4715, 1225, 13),
            (4732, 1241, 11), (4743, 1252, 11), (4757, 1265, 11), (4769, 1276, 11), (4820, 1287, 30), (4866, 1317, 35),
            (4987, 1352, 19), (5007, 1371, 12), (5008, 1383, 27), (5040, 1410, 21), (5050, 1431, 11), (5080, 1442, 15),
            (5111, 1457, 18), (5130, 1475, 11), (5141, 1486, 11), (5153, 1497, 11), (5195, 1508, 11), (5207, 1519, 18),
            (5509, 1537, 50), (5246, 1587, 27), (5584, 1614, 33), (5710, 1647, 12), (5710, 1659, 11), (5736, 1670, 21),
            (5761, 1691, 16), (5778, 1707, 11), (5789, 1718, 19), (5810, 1737, 35), (5846, 1772, 12), (5846, 1784, 20),
            (5847, 1804, 12), (5890, 1816, 12), (5892, 1828, 19), (5900, 1847, 11), (5926, 1858, 24), (5940, 1882, 11),
            (5972, 1893, 11), (5984, 1904, 31), (6016, 1935, 11), (6055, 1946, 16), (6072, 1962, 19), (6092, 1981, 11),
            (6126, 1992, 11), (6138, 2003, 16), (6155, 2019, 13), (6168, 2032, 15), (6184, 2047, 12), (6185, 2059, 11),
            (6220, 2070, 14), (6224, 2084, 11), (6241, 2095, 20), (6263, 2115, 33), (6280, 2148, 11), (6307, 2159, 32),
            (6340, 2191, 51), (6385, 2242, 39), (6433, 2281, 11), (6350, 2292, 36), (6411, 2328, 21), (6433, 2349, 11),
            (6445, 2360, 11), (6579, 2371, 16), (6596, 2387, 12), (6597, 2399, 11), (6620, 2410, 16), (6686, 2426, 12),
            (6690, 2438, 11), (6710, 2449, 11), (6721, 2460, 11), (6920, 2471, 18), (6994, 2489, 19), (7351, 2508, 20),
            (7519, 2528, 11), (7530, 2539, 26), (7706, 2565, 36), (7706, 2601, 11), (7757, 2612, 21), (7761, 2633, 17),
            (7820, 2650, 41), (7861, 2691, 47), (7920, 2738, 11), (7953, 2749, 26), (7980, 2775, 11), (7991, 2786, 20),
            (8012, 2806, 47), (8061, 2853, 14), (8076, 2867, 14), (8040, 2881, 12), (8035, 2893, 27), (8052, 2920, 11),
            (8090, 2931, 11), (8182, 2942, 11), (8243, 2953, 16), (8260, 2969, 11), (8272, 2980, 53), (8294, 3033, 26),
            (8797, 3059, 29), (8963, 3088, 12), (8964, 3100, 17), (8994, 3117, 11), (9023, 3128, 17), (9319, 3145, 37),
            (9458, 3182, 11), (9458, 3193, 11), (9467, 3204, 17), (9481, 3221, 11), (9510, 3232, 37), (9550, 3269, 11),
            (9628, 3280, 11), (9640, 3291, 12), (9653, 3303, 12), (9654, 3315, 11), (9852, 3326, 13), (9830, 3339, 14),
            (9560, 3353, 30), (9852, 3383, 13), (9854, 3396, 11), (9745, 3407, 11), (9850, 3418, 15), (9730, 3433, 27),
            (9854, 3460, 11), (9750, 3471, 11), (10011, 3482, 11), (10210, 3493, 11), (10224, 3504, 14),
            (10240, 3518, 27), (10304, 3545, 13), (10318, 3558, 34), (10320, 3592, 17), (10354, 3609, 40),
            (10335, 3649, 11), (10424, 3660, 26), (10663, 3686, 12), (10660, 3698, 11), (10686, 3709, 11),
            (10697, 3720, 11), (10710, 3731, 13), (10710, 3744, 11), (10740, 3761, 11), (10780, 3772, 12),
            (10792, 3784, 15), (10868, 3799, 16), (10880, 3815, 11), (10896, 3826, 15), (11055, 3841, 15),
            (11071, 3856, 11), (11082, 3867, 12), (11095, 3879, 14), (11330, 3893, 14), (11330, 3907, 13),
            (11456, 3920, 11), (11467, 3931, 14), (11482, 3945, 13), (11562, 3958, 11), (11574, 3969, 14),
            (11588, 3983, 12), (11800, 3995, 34), (11891, 4029, 15), (11900, 4044, 12), (11909, 4056, 11),
            (11977, 4067, 35), (12013, 4102, 12), (12026, 4114, 25), (12052, 4139, 12), (12053, 4151, 11),
            (12076, 4162, 12), (12090, 4174, 12), (12089, 4186, 14), (12104, 4200, 11), (12127, 4211, 19),
            (12147, 4230, 14), (12161, 4244, 12), (12162, 4256, 11), (12200, 4267, 12), (12201, 4279, 11),
            (12259, 4290, 11), (12271, 4301, 11), (12550, 4312, 12), (12549, 4324, 11), (12573, 4335, 11),
            (12742, 4346, 17), (12760, 4363, 11), (12810, 4374, 37), (13031, 4411, 22), (13054, 4433, 11),
            (13066, 4444, 15), (13191, 4459, 13), (13205, 4472, 15), (13220, 4487, 11), (13428, 4498, 12),
            (13440, 4510, 11), (13452, 4521, 14), (13466, 4535, 13), (13480, 4548, 11), (13792, 4559, 13),
            (13807, 4572, 12), (13820, 4584, 11), (13954, 4595, 44), (13990, 4639, 58), (14050, 4697, 11),
            (14076, 4708, 40), (14116, 4748, 24), (14141, 4772, 23), (14184, 4795, 12), (14197, 4807, 11),
            (14208, 4818, 11), (14276, 4829, 19), (14297, 4848, 28), (14326, 4876, 11), (14337, 4887, 11),
            (14364, 4898, 11), (14376, 4909, 15), (14464, 4924, 11), (14757, 4935, 14), (14772, 4949, 12),
            (14782, 4961, 11), (14822, 4972, 12), (14823, 4984, 36), (14871, 5020, 11), (14883, 5031, 40),
            (14925, 5071, 12), (14926, 5083, 11), (14949, 5094, 12), (14961, 5106, 16), (14978, 5122, 12),
            (14980, 5134, 11), (15002, 5145, 26), (15030, 5171, 13), (15031, 5184, 11), (15054, 5195, 11),
            (15071, 5206, 11), (15300, 5217, 32), (15516, 5249, 35), (15541, 5284, 11), (15558, 5295, 11),
            (15575, 5306, 14), (15590, 5320, 18), (15610, 5338, 21), (15631, 5359, 11), (15642, 5370, 11),
            (15654, 5381, 11), (15665, 5392, 17)]


def get_file_by_path(f_list, temp_path):
    for f in f_list:
        if f.file_path == temp_path:
            return f

    file = PrFile().generate_file(temp_path)
    print(f'create file [{temp_path}] len f_list = [{len(f_list)}]')

    f_list.append(file)

    return file


def generate_clip_item(a_start, b_start, temp_length, temp_path, temp_file_list):
    temp_ffile = get_file_by_path(temp_file_list, temp_path)
    clip_item = ClipItem().generate_clip_item_full((b_start, b_start + temp_length), (a_start, a_start + temp_length),
                                                   fps=temp_ffile.fps, total_frames=temp_ffile.total_frames,
                                                   name=BLUtils.get_filename(temp_ffile.file_path))
    clip_item.file = temp_ffile

    return clip_item


if __name__ == '__main__':
    ab_points = get_ab_point()

    a_path = "F:/xunleiyunpan/S02E06.Hard.Boiled.Eggy.mkv"
    b_path = "E:/360MoveData/Users/MrB/Desktop/企鹅特工孵化鸭子，用训练作为胎教，结果鸭子一出生就成为特工@不正经的小酥肉.mp4"

    clip_item_path = '../static/xml_template/clip_item_template.xml'

    with open(clip_item_path, 'r') as f:
        data = f.read()
        # print(data)

    for a_s, b_s, length in ab_points:
        clip_id = uuid.uuid4().__str__()
        start, end = b_s, b_s + length
        in_, out = a_s, a_s + length

        temp_data = data
        temp_data = temp_data.replace('{clip_item_id}', clip_id)
        temp_data = temp_data.replace('{start}', str(start))
        temp_data = temp_data.replace('{end}', str(end))
        temp_data = temp_data.replace('{in}', str(in_))
        temp_data = temp_data.replace('{out}', str(out))

        print(temp_data)

# if __name__ == '__main__':
#     ab_points = get_ab_point()
#
#     a_path = "F:/xunleiyunpan/S02E06.Hard.Boiled.Eggy.mkv"
#     b_path = "E:/360MoveData/Users/MrB/Desktop/企鹅特工孵化鸭子，用训练作为胎教，结果鸭子一出生就成为特工@不正经的小酥肉.mp4"
#
#     ps = PrSequenceUtils()
#     file_list = []
#
#     tbar = tqdm(desc='生成xml对象', unit='个', total=len(ab_points))
#
#     a_name, a_total_frames, a_fps, a_width_height = BLUtils.get_video_info(a_path)
#     b_name, b_total_frames, b_fps, b_width_height = BLUtils.get_video_info(a_path)
#
#     for a_s, b_s, length in ab_points:
#         b_clip_item = ClipItem.init(name=b_name, total_frames=b_total_frames, fps=b_fps, file_path=b_path,
#                                     width_height=b_width_height,
#                                     in_out=(b_s, b_s + length), start_end=(b_s, b_s + length), p_in_out=(-1, -1))
#
#         a_clip_item = ClipItem.init(name=a_name, total_frames=a_total_frames, fps=a_fps, file_path=a_path,
#                                     width_height=a_width_height,
#                                     start_end=(a_s, a_s + length), in_out=(b_s, b_s + length), p_in_out=(-1, -1))
#
#         ps.add_clip_item('original_video', b_clip_item)
#         ps.add_clip_item('generated_video', a_clip_item)
#
#         tbar.update(1)
#
#     tbar.close()
#     ps.save_to_xml()
